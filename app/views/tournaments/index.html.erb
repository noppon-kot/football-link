<div class="app-shell">
  <header class="app-header">
    <div class="app-top-nav">
      <div class="app-top-nav-left"></div>
      <div class="app-top-nav-center">‡∏ü‡∏∏‡∏ï‡∏ö‡∏≠‡∏•‡πÄ‡∏î‡∏¥‡∏ô‡∏™‡∏≤‡∏¢</div>
      <div class="app-top-nav-right"></div>
    </div>
    <div class="app-header-title">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏Ç‡πà‡∏á</div>
  </header>

  <div class="container py-3">
    <div class="row mb-3">
      <div class="col-12">
        <div class="card shadow-sm">
          <div class="card-body">
            <%= form_with url: tournaments_path, method: :get, local: true do |f| %>
              <div class="row g-2 align-items-center mb-2">
                <div class="col-8 col-md-10">
                  <%= f.text_field :q, value: params[:q], placeholder: "‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤...", class: "form-control form-control-sm" %>
                </div>
                <div class="col-4 col-md-2 text-end">
                  <button type="submit" class="btn btn-sm btn-primary w-100">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
                </div>
              </div>

              <div class="row g-2">
                <div class="col-6">
                  <%= f.select :age_category,
                        options_for_select([["‡∏ó‡∏∏‡∏Å‡∏ä‡πà‡∏ß‡∏á‡∏≠‡∏≤‡∏¢‡∏∏", ""]] + @age_categories.map { |a| [a, a] }, params[:age_category]),
                        {},
                        class: "form-select",
                        onchange: "this.form.submit()" %>
                </div>

                <div class="col-6">
                  <%= f.select :province,
                        options_for_select([["‡∏ó‡∏∏‡∏Å‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î", ""]] + @provinces.map { |p| [p, p] }, params[:province]),
                        {},
                        class: "form-select",
                        onchange: "this.form.submit()" %>
                </div>
              </div>
            <% end %>
          </div>
        </div>
      </div>
    </div>

    <div class="row mb-2">
      <div class="col-12">
        <span class="badge bg-secondary">‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</span>
      </div>
    </div>

    <div class="row g-3">
      <% if @tournaments.any? %>
        <% @tournaments.each_with_index do |tournament, index| %>
          <% bg_class = begin
               age = tournament.age_category.to_s
               if age =~ /\AU(\d+)\z/ && $1.to_i < 20
                 "tournament-card--bg1"
               else
                 "tournament-card--bg2"
               end
             end %>

          <% if index < 4 %>
            <!-- ‡∏™‡∏µ‡πà‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏£‡∏Å: ‡∏Å‡∏≤‡∏£‡πå‡∏î‡πÉ‡∏´‡∏ç‡πà‡πÄ‡∏ï‡πá‡∏°‡πÉ‡∏ö ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏£‡∏π‡∏õ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á (2 ‡πÉ‡∏ö‡∏ï‡πà‡∏≠‡πÅ‡∏ñ‡∏ß‡∏ö‡∏ô‡∏à‡∏≠‡πÉ‡∏´‡∏ç‡πà) -->
            <div class="col-12 col-md-6">
              <div class="tournament-card <%= bg_class %>">
                <div class="tournament-card-body">
                  <div class="tournament-title">
                    <%= link_to tournament.title, tournament_path(tournament), style: "color: inherit; text-decoration: none;" %>
                  </div>
                  <div class="tournament-meta">
                    <div>7 - 8 ‡∏Å.‡∏û. 2026</div>
                    <div>üìç <%= tournament.location_name %> ¬∑ <%= tournament.city %>, <%= tournament.province %></div>
                    <div>üë• ‡∏ó‡∏µ‡∏°‡∏•‡∏∞ <%= tournament.team_size %> ‡∏Ñ‡∏ô</div>
                    <div class="tournament-meta-divider"></div>
                    <div>
                      üèÜ ‡πÄ‡∏á‡∏¥‡∏ô‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏• <%= number_to_currency(tournament.prize_amount, unit: "‡∏ø", precision: 0) %>
                      ¬∑ ‡∏Ñ‡πà‡∏≤‡∏™‡∏°‡∏±‡∏Ñ‡∏£ <%= number_to_currency(tournament.entry_fee, unit: "‡∏ø", precision: 0) %>
                    </div>
                  </div>
                </div>
                <div class="tournament-footer">
                  <div class="tournament-footer-left">
                    <span class="tournament-footer-dot"></span>
                    <span class="tournament-footer-text">‡∏°‡∏µ‡∏ó‡∏µ‡∏°‡∏™‡∏ô‡πÉ‡∏à‡∏™‡∏°‡∏±‡∏Ñ‡∏£ <%= tournament.team_registrations.count %> ‡∏ó‡∏µ‡∏°</span>
                  </div>
                  <div class="tournament-footer-actions">
                    <%= link_to "‡∏™‡∏ô‡πÉ‡∏à‡∏™‡∏°‡∏±‡∏Ñ‡∏£", tournament_path(tournament), class: "btn-pill btn-interest" %>
                    <%= link_to "‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î", tournament_path(tournament), class: "btn-pill btn-apply" %>
                  </div>
                </div>
              </div>
            </div>
          <% else %>
            <!-- ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ñ‡∏±‡∏î‡πÑ‡∏õ: ‡∏Å‡∏≤‡∏£‡πå‡∏î compact 2 ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå -->
            <div class="col-12 col-md-6">
              <div class="tournament-card-compact">
                <div class="tournament-card-compact-image <%= bg_class %>"></div>
                <div class="tournament-card-compact-body">
                  <div class="tournament-title">
                    <%= link_to tournament.title, tournament_path(tournament), style: "color: inherit; text-decoration: none;" %>
                  </div>
                  <div class="tournament-meta">
                    <div>7 - 8 ‡∏Å.‡∏û. 2026</div>
                    <div>üìç <%= tournament.location_name %></div>
                    <div>üèÜ <%= number_to_currency(tournament.prize_amount, unit: "‡∏ø", precision: 0) %> ¬∑ ‡∏Ñ‡πà‡∏≤‡∏™‡∏°‡∏±‡∏Ñ‡∏£ <%= number_to_currency(tournament.entry_fee, unit: "‡∏ø", precision: 0) %></div>
                  </div>
                  <div class="tournament-card-compact-actions">
                    <%= link_to "‡∏™‡∏ô‡πÉ‡∏à‡∏™‡∏°‡∏±‡∏Ñ‡∏£", tournament_path(tournament), class: "btn-pill btn-interest" %>
                    <%= link_to "‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î", tournament_path(tournament), class: "btn-pill btn-apply" %>
                  </div>
                </div>
              </div>
            </div>
          <% end %>
        <% end %>
      <% else %>
        <div class="col-12">
          <div class="alert alert-info" role="alert">
            ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏Ç‡πà‡∏á‡πÉ‡∏ô‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏ô‡∏µ‡πâ
          </div>
        </div>
      <% end %>
    </div>

    <% if @total_pages > 1 %>
      <div class="d-flex justify-content-center mt-3">
        <nav aria-label="tournament-pages">
          <ul class="pagination pagination-sm mb-0">
            <% if @current_page > 1 %>
              <li class="page-item">
                <%= link_to "‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤", tournaments_path(request.query_parameters.merge(page: @current_page - 1)), class: "page-link" %>
              </li>
            <% end %>

            <% max_pages = 10 %>
            <% if @total_pages <= max_pages %>
              <% start_page = 1; end_page = @total_pages %>
            <% else %>
              <% half_window = max_pages / 2 %>
              <% start_page = @current_page - half_window %>
              <% end_page   = @current_page + half_window %>

              <% if start_page < 1 %>
                <% end_page += (1 - start_page) %>
                <% start_page = 1 %>
              <% end %>

              <% if end_page > @total_pages %>
                <% start_page -= (end_page - @total_pages) %>
                <% end_page = @total_pages %>
              <% end %>

              <% start_page = 1 if start_page < 1 %>
            <% end %>

            <% (start_page..end_page).each do |page| %>
              <% if page == @current_page %>
                <li class="page-item active"><span class="page-link"><%= page %></span></li>
              <% else %>
                <li class="page-item"><%= link_to page, tournaments_path(request.query_parameters.merge(page: page)), class: "page-link" %></li>
              <% end %>
            <% end %>

            <% if @current_page < @total_pages %>
              <li class="page-item">
                <%= link_to "‡∏ñ‡∏±‡∏î‡πÑ‡∏õ", tournaments_path(request.query_parameters.merge(page: @current_page + 1)), class: "page-link" %>
              </li>
            <% end %>
          </ul>
        </nav>
      </div>
    <% end %>
  </div>
</div>

<script>
  (function() {
    var toggle = document.getElementById('app-menu-toggle');
    var menu   = document.getElementById('app-menu');
    if (!toggle || !menu) return;

    toggle.addEventListener('click', function() {
      if (menu.style.display === 'none' || menu.style.display === '') {
        menu.style.display = 'block';
      } else {
        menu.style.display = 'none';
      }
    });
  })();
</script>
