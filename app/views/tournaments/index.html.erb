<div class="app-shell">
  <header class="app-header" style="background-image:url('<%= asset_path("banner1.png") %>');background-size:cover;background-position:center;min-height:150px;">
    <div class="app-top-nav">
      <div class="app-top-nav-left"></div>
      <div class="app-top-nav-center" style="text-shadow:0 0 3px rgba(0,0,0,0.9),0 0 6px rgba(0,0,0,0.7);">ฟุตบอลเดินสาย</div>
      <div class="app-top-nav-right"></div>
    </div>
    <div class="app-header-title" style="text-shadow:0 0 3px rgba(0,0,0,0.9),0 0 6px rgba(0,0,0,0.7);">ค้นหารายการแข่ง</div>
  </header>

  <div class="container py-3">
    <div class="row mb-3">
      <div class="col-12">
        <div class="card shadow-sm">
          <div class="card-body">
            <%= form_with url: tournaments_path, method: :get, local: true do |f| %>
              <div class="row g-2 align-items-center mb-2">
                <div class="col-8 col-md-10">
                  <%= f.text_field :q, value: params[:q], placeholder: "ค้นหาคำว่า...", class: "form-control form-control-sm" %>
                </div>
                <div class="col-4 col-md-2 text-end">
                  <button type="submit" class="btn btn-sm btn-primary w-100">ค้นหา</button>
                </div>
              </div>

              <div class="row g-2">
                <div class="col-6">
                  <%= f.select :age_category,
                        options_for_select([["ทุกช่วงอายุ", ""]] + @age_categories.map { |a| [a, a] }, params[:age_category]),
                        {},
                        class: "form-select",
                        onchange: "this.form.submit()" %>
                </div>

                <div class="col-6">
                  <%= f.select :province,
                        options_for_select([["ทุกจังหวัด", ""]] + @provinces.map { |p| [p, p] }, params[:province]),
                        {},
                        class: "form-select",
                        onchange: "this.form.submit()" %>
                </div>
              </div>
            <% end %>
          </div>
        </div>
      </div>
    </div>

    <div class="row mb-2 align-items-center">
      <div class="col-auto">
        <span class="badge bg-secondary">ผลลัพธ์การค้นหา</span>
      </div>
      <div class="col text-end">
        <%= link_to "เพิ่มรายการแข่งขัน", new_tournament_path, class: "btn btn-danger btn-sm" %>
      </div>
    </div>

    <% if @tournaments.any? %>
      <div class="card shadow-sm">
        <div class="card-body p-2 p-md-3">
          <div class="table-responsive">
            <table class="table table-sm align-middle mb-0">
              <thead>
                <tr>
                  <th scope="col" style="width:4rem;">ลำดับ</th>
                  <th scope="col">ชื่อการแข่งขัน</th>
                  <th scope="col">วันที่จัด</th>
                  <th scope="col">รุ่นอายุ</th>
                  <th scope="col" class="text-end d-none d-md-table-cell">&nbsp;</th>
                </tr>
              </thead>
              <tbody>
                <% @tournaments.each_with_index do |tournament, index| %>
                  <tr>
                    <td class="text-muted"><%= (@current_page - 1) * 10 + index + 1 %></td>
                    <td>
                      <div class="fw-semibold">
                        <%= link_to tournament.title, tournament_path(tournament), style: "color: inherit; text-decoration: none;" %>
                      </div>
                      <div class="small text-muted">
                        <%= tournament.location_name %> · <%= tournament.city %>, <%= tournament.province %>
                      </div>
                      <div class="mt-1 d-md-none">
                        <%= link_to "รายละเอียด", tournament_path(tournament), class: "text-primary small" %>
                      </div>
                    </td>
                    <td class="small">
                      <%= tournament.competition_date&.strftime("%Y-%m-%d") || "-" %>
                    </td>
                    <td class="small">
                      <% division_names = tournament.tournament_divisions.order(:position, :id).pluck(:name) %>
                      <%= (division_names.presence || [tournament.age_category]).join(', ') %>
                    </td>
                    <td class="text-end d-none d-md-table-cell">
                      <%= link_to "รายละเอียด", tournament_path(tournament), class: "btn btn-sm btn-outline-primary" %>
                    </td>
                  </tr>
                <% end %>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    <% else %>
      <div class="row">
        <div class="col-12">
          <div class="alert alert-info" role="alert">
            ยังไม่มีรายการแข่งในจังหวัดนี้
          </div>
        </div>
      </div>
    <% end %>

    <% if @total_pages > 1 %>
      <div class="d-flex justify-content-center mt-3">
        <nav aria-label="tournament-pages">
          <ul class="pagination pagination-sm mb-0">
            <% if @current_page > 1 %>
              <li class="page-item">
                <%= link_to "ก่อนหน้า", tournaments_path(request.query_parameters.merge(page: @current_page - 1)), class: "page-link" %>
              </li>
            <% end %>

            <% max_pages = 10 %>
            <% if @total_pages <= max_pages %>
              <% start_page = 1; end_page = @total_pages %>
            <% else %>
              <% half_window = max_pages / 2 %>
              <% start_page = @current_page - half_window %>
              <% end_page   = @current_page + half_window %>

              <% if start_page < 1 %>
                <% end_page += (1 - start_page) %>
                <% start_page = 1 %>
              <% end %>

              <% if end_page > @total_pages %>
                <% start_page -= (end_page - @total_pages) %>
                <% end_page = @total_pages %>
              <% end %>

              <% start_page = 1 if start_page < 1 %>
            <% end %>

            <% (start_page..end_page).each do |page| %>
              <% if page == @current_page %>
                <li class="page-item active"><span class="page-link"><%= page %></span></li>
              <% else %>
                <li class="page-item"><%= link_to page, tournaments_path(request.query_parameters.merge(page: page)), class: "page-link" %></li>
              <% end %>
            <% end %>

            <% if @current_page < @total_pages %>
              <li class="page-item">
                <%= link_to "ถัดไป", tournaments_path(request.query_parameters.merge(page: @current_page + 1)), class: "page-link" %>
              </li>
            <% end %>
          </ul>
        </nav>
      </div>
    <% end %>
  </div>
</div>

<script>
  (function() {
    var toggle = document.getElementById('app-menu-toggle');
    var menu   = document.getElementById('app-menu');
    if (!toggle || !menu) return;

    toggle.addEventListener('click', function() {
      if (menu.style.display === 'none' || menu.style.display === '') {
        menu.style.display = 'block';
      } else {
        menu.style.display = 'none';
      }
    });
  })();
</script>
