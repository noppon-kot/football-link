<div class="app-shell">
  <% bg_image = begin
       age_str = @tournament.age_category.to_s
       if age_str =~ /U(\d+)/ && $1.to_i < 20
         "back1.png"
       else
         "back2.png"
       end
     end %>
  <div class="tournament-show-header">
    <div style="position:absolute;inset:0;background-image:url('<%= asset_path(bg_image) %>');background-size:cover;background-position:center;filter:brightness(0.8);"></div>
    <div style="position:relative;">
      <div class="tournament-show-title"><%= @tournament.title %></div>
      <div class="tournament-show-subtitle">
        7 - 8 ก.พ. 2026 · <%= @tournament.location_name %>
      </div>
      <div class="tournament-show-actions">
        <% if can_edit_tournament?(@tournament) %>
          <%= link_to "แก้ไข", edit_tournament_path(@tournament), class: "btn-pill btn-apply", style: "margin-right:6px;" %>
        <% end %>
      </div>
    </div>
  </div>

  <script>
    // simple tab handler for teams by division (ใช้ event delegation จาก document)
    (function() {
      document.addEventListener('click', function(e) {
        var tab = e.target.closest('.team-tab');
        if (!tab) return;

        var tabsContainer = tab.parentElement;
        var panelsContainer = document.getElementById('team-tab-panels');
        if (!tabsContainer || !panelsContainer) return;

        var targetId = tab.getAttribute('data-tab');
        if (!targetId) return;

        // toggle active tab
        var allTabs = tabsContainer.querySelectorAll('.team-tab');
        allTabs.forEach(function(t) { t.classList.remove('team-tab--active'); });
        tab.classList.add('team-tab--active');

        // toggle panels
        var allPanels = panelsContainer.querySelectorAll('.team-tab-panel');
        allPanels.forEach(function(panel) {
          panel.style.display = (panel.id === targetId) ? 'block' : 'none';
        });
      });
    })();
  </script>

  <div class="tournament-show-body">
    <div class="tournament-info-card">
      <% if @tournament.description.present? %>
        <div class="tournament-description">
          <div class="tournament-description-label">รายละเอียด</div>
          <div class="tournament-description-body"><%= simple_format(@tournament.description) %></div>
        </div>
      <% end %>

      <div><span class="label">จำนวนผู้เล่น:</span> <%= @tournament.team_size %> คน</div>

      <div style="margin-top:4px;">
        <div><span class="label">วันเปิดรับสมัคร:</span> <%= @tournament.registration_open_on&.strftime("%Y-%m-%d") %></div>
        <div><span class="label">วันปิดรับสมัคร:</span> <%= @tournament.registration_close_on&.strftime("%Y-%m-%d") %></div>
        <div><span class="label">วันแข่งขัน:</span> <%= @tournament.competition_date&.strftime("%Y-%m-%d") %></div>
      </div>

      <div style="margin-top:4px;">
        <span class="label">สถานะรายการ:</span>
        <% status_label = if @tournament.pending?
                            "รออนุมัติจากแอดมิน"
                          elsif @tournament.expired?
                            "หมดอายุ (แข่งเสร็จแล้ว)"
                          else
                            "เปิดให้ค้นหาและสมัครได้"
                          end %>
        <%= status_label %>
      </div>

      <% divisions = @tournament.tournament_divisions.order(:position, :id) %>
      <% if divisions.any? %>
        <div style="margin-top:8px;">
          <div class="tournament-description-label" style="margin-bottom:4px;">รุ่นที่เปิดแข่ง</div>
          <% divisions.each do |div| %>
            <div style="padding:4px 0;border-top:1px solid #eceff1;">
              <div><span class="label">ช่วงอายุ:</span> <%= div.name %></div>
              <% if div.entry_fee.present? %>
                <div><span class="label">ค่าสมัครรุ่นนี้:</span> <%= number_to_currency(div.entry_fee, unit: "฿", precision: 0) %></div>
              <% end %>
              <% if div.prize_amount.present? %>
                <div><span class="label">รางวัลรุ่นนี้:</span> <%= number_to_currency(div.prize_amount, unit: "฿", precision: 0) %></div>
              <% end %>
            </div>
          <% end %>
        </div>
      <% else %>
        <div><span class="label">ช่วงอายุ (หลัก):</span> <%= @tournament.age_category %></div>
        <div><span class="label">ค่าสมัคร:</span> <%= number_to_currency(@tournament.entry_fee, unit: "฿", precision: 0) %></div>
        <div><span class="label">รางวัล:</span> <%= number_to_currency(@tournament.prize_amount, unit: "฿", precision: 0) %></div>
      <% end %>

      <div style="margin-top:8px;"><span class="label">ผู้จัด:</span> <%= @tournament.organizer.name %> (<%= @tournament.organizer.phone %>)</div>
      <% if @tournament.contact_phone.present? %>
        <div><span class="label">เบอร์โทรผู้ติดต่อรายการแข่ง:</span> <%= @tournament.contact_phone %></div>
      <% end %>
      <% if @tournament.line_id.present? %>
        <div style="margin-top:8px;">
          <% line_url = "line://ti/p/~#{@tournament.line_id}" %>
          <%= link_to "LINE ID: #{@tournament.line_id}",
                      line_url,
                      class: "btn-pill btn-apply",
                      style: "background-color:#00c300;border-color:#00c300;color:#ffffff;" %>
        </div>
      <% end %>
    </div>

    <div class="team-list-card">
      <div class="team-list-header">ทีมที่สนใจ / สมัคร</div>
      <% divisions = @tournament.tournament_divisions.order(:position, :id).to_a %>
      <% regs_without_div = @tournament.team_registrations.where(tournament_division_id: nil).includes(:team).to_a %>
      <% status_order = { "confirmed" => 0, "paid" => 0, "applied" => 1, "interested" => 1 } %>

      <% if divisions.any? || @tournament.team_registrations.any? %>

        <div class="team-tabs" id="team-tabs">
          <% divisions.each_with_index do |div, idx| %>
            <% count = div.team_registrations.count %>
            <button
              type="button"
              class="team-tab <%= 'team-tab--active' if idx == 0 %>"
              data-tab="division-<%= div.id %>">
              <span><%= div.name %></span>
              <span class="team-tab-count"><%= count %></span>
            </button>
          <% end %>
          <% if regs_without_div.any? %>
            <button
              type="button"
              class="team-tab <%= 'team-tab--active' if divisions.empty? %>"
              data-tab="division-unassigned">
              <span>ไม่ระบุรุ่น</span>
              <span class="team-tab-count"><%= regs_without_div.size %></span>
            </button>
          <% end %>
        </div>

        <div class="team-tab-panels" id="team-tab-panels">
          <% divisions.each_with_index do |div, idx| %>
            <% regs = div.team_registrations.includes(:team).to_a %>
            <% sorted_regs = regs.sort_by { |reg| [status_order[reg.status] || 1, reg.created_at] } %>
            <div
              class="team-tab-panel"
              id="division-<%= div.id %>"
              style="display:<%= idx == 0 ? 'block' : 'none' %>;">
              <% if sorted_regs.any? %>
                <% sorted_regs.each do |reg| %>
                  <% display_state = case reg.status
                                     when "confirmed", "paid" then :confirmed
                                     else :applied
                                     end %>

                  <% badge_class = case display_state
                                   when :applied   then "team-status-badge team-status-badge--applied"
                                   when :confirmed then "team-status-badge team-status-badge--confirmed"
                                   end %>

                  <% label = display_state == :applied ? "สมัครแล้ว" : "ยืนยันแล้ว" %>
                  <div class="team-list-row">
                    <div>
                      <div><strong><%= reg.team.name %></strong></div>
                      <div style="font-size:11px;color:#78909c;">โทร: <%= reg.team.contact_phone %></div>
                    </div>
                    <div style="display:flex;align-items:center;gap:6px;">
                      <% if can_manage_registrations?(@tournament) %>
                        <% target_status = (display_state == :confirmed ? "applied" : "confirmed") %>
                        <%= button_to label,
                              tournament_team_registration_path(@tournament, reg),
                              method: :patch,
                              params: { team_registration: { status: target_status } },
                              class: "team-status-badge #{badge_class}",
                              form_class: "inline-form" %>
                        <%= button_to "ลบ",
                              tournament_team_registration_path(@tournament, reg),
                              method: :delete,
                              data: { confirm: "ลบทีมนี้ออกจากรายการแข่ง?" },
                              class: "btn-pill btn-secondary",
                              form_class: "inline-form" %>
                      <% else %>
                        <div class="<%= badge_class %>"><%= label %></div>
                      <% end %>
                    </div>
                  </div>
                <% end %>
              <% else %>
                <div class="team-list-row">ยังไม่มีทีมที่สนใจหรือสมัครในรุ่นนี้</div>
              <% end %>
            </div>
          <% end %>

          <% if regs_without_div.any? %>
            <div
              class="team-tab-panel"
              id="division-unassigned"
              style="display:<%= divisions.empty? ? 'block' : 'none' %>;">
              <% sorted_regs = regs_without_div.sort_by { |reg| [status_order[reg.status] || 1, reg.created_at] } %>
              <% sorted_regs.each do |reg| %>
                <% display_state = case reg.status
                                   when "confirmed", "paid" then :confirmed
                                   else :applied
                                   end %>

                <% badge_class = case display_state
                                 when :applied   then "team-status-badge team-status-badge--applied"
                                 when :confirmed then "team-status-badge team-status-badge--confirmed"
                                 end %>

                <% label = display_state == :applied ? "สมัครแล้ว" : "ยืนยันแล้ว" %>
                <div class="team-list-row">
                  <div>
                    <div><strong><%= reg.team.name %></strong></div>
                    <div style="font-size:11px;color:#78909c;">โทร: <%= reg.team.contact_phone %></div>
                  </div>
                  <div style="display:flex;align-items:center;gap:6px;">
                    <% if can_manage_registrations?(@tournament) %>
                      <% target_status = (display_state == :confirmed ? "applied" : "confirmed") %>
                      <%= button_to label,
                            tournament_team_registration_path(@tournament, reg),
                            method: :patch,
                            params: { team_registration: { status: target_status } },
                            class: "team-status-badge #{badge_class}",
                            form_class: "inline-form" %>
                      <%= button_to "ลบ",
                            tournament_team_registration_path(@tournament, reg),
                            method: :delete,
                            data: { confirm: "ลบทีมนี้ออกจากรายการแข่ง?" },
                            class: "btn-pill btn-secondary",
                            form_class: "inline-form" %>
                    <% else %>
                      <div class="<%= badge_class %>"><%= label %></div>
                    <% end %>
                  </div>
                </div>
              <% end %>
            </div>
          <% end %>
        </div>
      <% else %>
        <div class="team-list-row">ยังไม่มีทีมที่สนใจหรือสมัคร</div>
      <% end %>
    </div>
  </div>

  <div class="tournament-show-bottom-bar">
    <div style="display:flex;gap:8px;">
      <%= link_to "สมัครแข่งขัน", new_tournament_team_registration_path(@tournament), class: "link-button", style: "background-color:#e53935;color:#ffffff;border-color:#e53935;" %>
    </div>
  </div>
</div>
