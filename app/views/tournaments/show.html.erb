<div class="app-shell">
  <% bg_image = "banner2.png" %>
  <div class="tournament-show-header">
    <div style="position:absolute;inset:0;background-image:url('<%= asset_path(bg_image) %>');background-size:cover;background-position:center;filter:brightness(0.8);"></div>
    <div style="position:relative;">
      <div class="tournament-show-title"><%= @tournament.title %></div>
      <div class="tournament-show-subtitle">
        7 - 8 ก.พ. 2026 · <%= @tournament.location_name %>
      </div>
      <div class="tournament-show-actions" style="margin-top:6px;display:flex;gap:6px;">
        <% if can_edit_tournament?(@tournament) %>
          <%= link_to "แก้ไข", edit_tournament_path(@tournament), class: "btn btn-sm btn-light" %>
        <% end %>
        <% if admin? %>
          <%= button_to "ลบรายการแข่ง",
                        tournament_path(@tournament),
                        method: :delete,
                        data: { turbo_confirm: "ยืนยันลบรายการแข่งนี้? ข้อมูลทั้งหมดที่เกี่ยวข้องจะถูกลบด้วย" },
                        class: "btn btn-sm btn-danger" %>
        <% end %>
      </div>
    </div>
  </div>

  <script>
    // simple tab handler for teams by division (ใช้ event delegation จาก document)
    (function() {
      document.addEventListener('click', function(e) {
        var tab = e.target.closest('.team-tab');
        if (!tab) return;

        var tabsContainer = tab.parentElement;
        var panelsContainer = document.getElementById('team-tab-panels');
        if (!tabsContainer || !panelsContainer) return;

        var targetId = tab.getAttribute('data-tab');
        if (!targetId) return;

        // toggle active tab
        var allTabs = tabsContainer.querySelectorAll('.team-tab');
        allTabs.forEach(function(t) { t.classList.remove('team-tab--active'); });
        tab.classList.add('team-tab--active');

        // toggle panels
        var allPanels = panelsContainer.querySelectorAll('.team-tab-panel');
        allPanels.forEach(function(panel) {
          panel.style.display = (panel.id === targetId) ? 'block' : 'none';
        });
      });
    })();

    // explicit tab handler for main tournament tabs เพื่อให้ซ่อน/แสดง pane ถูกต้องเสมอ
    (function() {
      function activateTabBySelector(targetSelector) {
        var tabsContainer = document.getElementById('tournament-main-tabs');
        var contentContainer = document.getElementById('tournament-main-tabs-content');
        if (!tabsContainer || !contentContainer) return;

        var tabLink = tabsContainer.querySelector('[data-bs-target="' + targetSelector + '"]');
        if (!tabLink) return;

        // toggle active on nav links
        var allLinks = tabsContainer.querySelectorAll('.nav-link');
        allLinks.forEach(function(link) { link.classList.remove('active'); });
        tabLink.classList.add('active');

        // toggle panes
        var allPanes = contentContainer.querySelectorAll('.tab-pane');
        allPanes.forEach(function(pane) {
          pane.classList.remove('show', 'active');
        });

        var targetPane = contentContainer.querySelector(targetSelector);
        if (targetPane) {
          targetPane.classList.add('show', 'active');
        }
      }

      document.addEventListener('click', function(e) {
        var tabLink = e.target.closest('#tournament-main-tabs .nav-link');
        if (!tabLink) return;

        var targetSelector = tabLink.getAttribute('data-bs-target');
        if (!targetSelector) return;

        activateTabBySelector(targetSelector);
      });

      // ถ้าเปิดหน้ามาพร้อม hash ของ panel-schedule ให้สลับแท็บให้อัตโนมัติ
      document.addEventListener('DOMContentLoaded', function() {
        if (window.location.hash === '#panel-schedule') {
          activateTabBySelector('#panel-schedule');
        }
      });
    })();
  </script>

  <div class="tournament-show-body">
    <div class="container py-2">
      <!-- Main navigation between subpages -->
      <%= render "tournaments/nav_tabs", active: :show %>

      <div class="tab-content" id="tournament-main-tabs-content">
        <div
          class="tab-pane fade show active"
          id="panel-general"
          role="tabpanel"
          aria-labelledby="tab-general">
          <div class="row g-3">
            <div class="col-12">
              <div class="tournament-info-card card shadow-sm">
      <% if @tournament.images.attached? %>
        <div class="mb-3">
          <%= image_tag @tournament.images.first,
                        class: "img-fluid rounded",
                        style: "width:100%;height:auto;" %>
        </div>
      <% end %>

      <% if @tournament.description.present? %>
        <div class="mb-3">
          <div class="fw-bold mb-1">รายละเอียด</div>
          <div class="small text-muted"><%= simple_format(@tournament.description) %></div>
        </div>
      <% end %>

      <div class="mb-2">
        <span class="fw-bold">จำนวนผู้เล่น:</span>
        <span class="ms-1"><%= @tournament.team_size %> คน</span>
      </div>

      <div class="mb-2">
        <div><span class="fw-bold">วันเปิดรับสมัคร:</span> <span class="ms-1"><%= @tournament.registration_open_on&.strftime("%Y-%m-%d") %></span></div>
        <div><span class="fw-bold">วันปิดรับสมัคร:</span> <span class="ms-1"><%= @tournament.registration_close_on&.strftime("%Y-%m-%d") %></span></div>
        <div><span class="fw-bold">วันแข่งขัน:</span> <span class="ms-1"><%= @tournament.competition_date&.strftime("%Y-%m-%d") %></span></div>
      </div>

      <div class="mb-3">
        <span class="fw-bold">สถานะรายการ:</span>
        <% status_label = if @tournament.pending?
                            "รออนุมัติจากแอดมิน"
                          elsif @tournament.expired?
                            "หมดอายุ (แข่งเสร็จแล้ว)"
                          else
                            "เปิดให้ค้นหาและสมัครได้"
                          end %>
        <span class="badge bg-info text-dark ms-1"><%= status_label %></span>
      </div>

      <% divisions = @tournament.tournament_divisions.order(:position, :id) %>
      <% if divisions.any? %>
        <div class="mb-3">
          <div class="fw-bold mb-1">รุ่นที่เปิดแข่ง</div>
          <div class="list-group list-group-flush">
            <% divisions.each do |div| %>
              <div class="list-group-item px-0 py-2">
                <div><span class="fw-bold">ช่วงอายุ:</span> <span class="ms-1"><%= div.name %></span></div>
                <% if div.entry_fee.present? %>
                  <div><span class="fw-bold">ค่าสมัครรุ่นนี้:</span> <span class="ms-1"><%= number_to_currency(div.entry_fee, unit: "฿", precision: 0) %></span></div>
                <% end %>
                <% if div.prize_amount.present? %>
                  <div><span class="fw-bold">รางวัลรุ่นนี้:</span> <span class="ms-1"><%= number_to_currency(div.prize_amount, unit: "฿", precision: 0) %></span></div>
                <% end %>
              </div>
            <% end %>
          </div>
        </div>
      <% else %>
        <div class="mb-1"><span class="fw-bold">ช่วงอายุ (หลัก):</span> <span class="ms-1"><%= @tournament.age_category %></span></div>
        <div class="mb-1"><span class="fw-bold">ค่าสมัคร:</span> <span class="ms-1"><%= number_to_currency(@tournament.entry_fee, unit: "฿", precision: 0) %></span></div>
        <div class="mb-3"><span class="fw-bold">รางวัล:</span> <span class="ms-1"><%= number_to_currency(@tournament.prize_amount, unit: "฿", precision: 0) %></span></div>
      <% end %>

      <div class="mb-1"><span class="fw-bold">ผู้จัด:</span> <span class="ms-1"><%= @tournament.organizer.name %> (<%= @tournament.organizer.phone %>)</span></div>
      <% if @tournament.contact_phone.present? %>
        <div class="mb-2"><span class="fw-bold">เบอร์โทรผู้ติดต่อรายการแข่ง:</span> <span class="ms-1"><%= @tournament.contact_phone %></span></div>
      <% end %>
          <% if @tournament.line_id.present? %>
            <div style="margin-top:8px;">
              <% line_url = "line://ti/p/~#{@tournament.line_id}" %>
              <%= link_to "LINE ID: #{@tournament.line_id}",
                          line_url,
                          class: "btn-pill btn-apply",
                          style: "background-color:#00c300;border-color:#00c300;color:#ffffff;" %>
            </div>
          <% end %>
        </div>
        </div>
      </div>

      <!-- team list moved to /tournaments/:id/teams -->
        </div> <!-- /col-12 general -->
      </div>   <!-- /row general -->
        </div> <!-- /tab-pane general -->

        <div
          class="tab-pane fade"
          id="panel-schedule"
          role="tabpanel"
          aria-labelledby="tab-schedule">
          <div class="card shadow-sm">
            <div class="card-body" style="font-size:13px;">
              <p class="mb-1 fw-bold">ตารางการแข่งขัน</p>
              <p class="mb-2 text-muted">กรุณาดูหรือจัดการตารางแข่งขันจากหน้าต่างหาก:</p>
              <%= link_to "ไปที่หน้าตารางการแข่งขัน", fixture_tournament_path(@tournament), class: "btn btn-sm btn-outline-primary" %>
            </div>
          </div>
          <div class="card shadow-sm mt-3">
            <div class="card-body" style="font-size:13px;">
              <p class="mb-1 fw-bold">ตารางคะแนน</p>
              <p class="mb-2 text-muted">กรุณาดูตารางคะแนนจากหน้าต่างหาก:</p>
              <%= link_to "ไปที่หน้าตารางคะแนน", table_tournament_path(@tournament), class: "btn btn-sm btn-outline-primary" %>
            </div>
          </div>
        </div>
      </div> <!-- /tab-content main -->
    </div>
  </div>

  <% has_schedule = Match.where(tournament_division_id: @tournament.tournament_divisions.select(:id)).exists? %>
  <% unless has_schedule %>
    <div class="tournament-show-bottom-bar">
      <div style="display:flex;gap:8px;">
        <%= link_to "สมัครแข่งขัน", new_tournament_team_registration_path(@tournament), class: "btn btn-danger w-100" %>
      </div>
    </div>
  <% end %>
</div>
