<div class="app-shell">
  <% bg_image = begin
       age_str = @tournament.age_category.to_s
       if age_str =~ /U(\d+)/ && $1.to_i < 20
         "back1.png"
       else
         "back2.png"
       end
     end %>
  <div class="tournament-show-header">
    <div style="position:absolute;inset:0;background-image:url('<%= asset_path(bg_image) %>');background-size:cover;background-position:center;filter:brightness(0.8);"></div>
    <div style="position:relative;">
      <div class="tournament-show-title"><%= @tournament.title %></div>
      <div class="tournament-show-subtitle">
        7 - 8 ก.พ. 2026 · <%= @tournament.location_name %>
      </div>
    </div>
  </div>

  <div class="tournament-show-body">
    <div class="container py-2">
      <ul class="nav nav-pills mb-3" id="tournament-main-tabs" role="tablist">
        <li class="nav-item" role="presentation">
          <%= link_to "ข้อมูลทั่วไป", tournament_path(@tournament), class: "nav-link" %>
        </li>
        <li class="nav-item" role="presentation">
          <%= link_to "ทีมแข่งขัน", teams_tournament_path(@tournament), class: "nav-link active" %>
        </li>
        <li class="nav-item" role="presentation">
          <%= link_to "ตารางการแข่งขัน", fixture_tournament_path(@tournament), class: "nav-link" %>
        </li>
        <li class="nav-item" role="presentation">
          <%= link_to "ตารางคะแนน", table_tournament_path(@tournament), class: "nav-link" %>
        </li>
      </ul>

      <h2 style="font-size:18px;font-weight:bold;" class="mb-2">ทีมที่สนใจ / สมัคร</h2>
      <p class="text-muted" style="font-size:13px;">รายการ: <%= @tournament.title %></p>
      <hr>

      <div class="team-list-card card shadow-sm">
        <div class="team-list-header">ทีมที่สนใจ / สมัคร</div>
        <% divisions = @tournament.tournament_divisions.order(:position, :id).to_a %>
        <% regs_without_div = @tournament.team_registrations.where(tournament_division_id: nil).includes(:team).to_a %>
        <% status_order = { "confirmed" => 0, "paid" => 0, "applied" => 1, "interested" => 1 } %>

        <% if divisions.any? || @tournament.team_registrations.any? %>

          <div class="team-tabs nav nav-pills mb-2" id="team-tabs">
            <% divisions.each_with_index do |div, idx| %>
              <% count = div.team_registrations.count %>
              <button
                type="button"
                class="team-tab btn btn-sm btn-outline-primary <%= 'team-tab--active' if idx == 0 %>"
                data-tab="division-<%= div.id %>">
                <span><%= div.name %></span>
                <span class="team-tab-count"><%= count %></span>
              </button>
            <% end %>
            <% if regs_without_div.any? %>
              <button
                type="button"
                class="team-tab btn btn-sm btn-outline-primary <%= 'team-tab--active' if divisions.empty? %>"
                data-tab="division-unassigned">
                <span>ไม่ระบุรุ่น</span>
                <span class="team-tab-count"><%= regs_without_div.size %></span>
              </button>
            <% end %>
          </div>

          <div class="team-tab-panels" id="team-tab-panels">
            <% divisions.each_with_index do |div, idx| %>
              <% regs = div.team_registrations.includes(:team).to_a %>
              <% sorted_regs = regs.sort_by { |reg| [status_order[reg.status] || 1, reg.created_at] } %>
              <div
                class="team-tab-panel"
                id="division-<%= div.id %>"
                style="display:<%= idx == 0 ? 'block' : 'none' %>;">
                <% if sorted_regs.any? %>
                  <% sorted_regs.each do |reg| %>
                    <% display_state = case reg.status
                                       when "confirmed", "paid" then :confirmed
                                       else :applied
                                       end %>

                    <% badge_class = case display_state
                                     when :applied   then "team-status-badge team-status-badge--applied"
                                     when :confirmed then "team-status-badge team-status-badge--confirmed"
                                     end %>

                    <% label = display_state == :applied ? "สมัครแล้ว" : "ยืนยันแล้ว" %>
                    <div class="team-list-row">
                      <div>
                        <div><strong><%= reg.team.name %></strong></div>
                        <div style="font-size:11px;color:#78909c;">โทร: <%= reg.team.contact_phone %></div>
                      </div>
                      <div style="display:flex;align-items:center;gap:6px;">
                        <% if can_manage_registrations?(@tournament) %>
                          <% target_status = (display_state == :confirmed ? "applied" : "confirmed") %>
                          <%= button_to label,
                                tournament_team_registration_path(@tournament, reg),
                                method: :patch,
                                params: { team_registration: { status: target_status } },
                                class: "team-status-badge #{badge_class}",
                                form_class: "inline-form" %>
                          <%= button_to "ลบ",
                                tournament_team_registration_path(@tournament, reg),
                                method: :delete,
                                data: { confirm: "ลบทีมนี้ออกจากรายการแข่ง?" },
                                class: "btn-pill btn-secondary",
                                form_class: "inline-form" %>
                        <% else %>
                          <div class="<%= badge_class %>"><%= label %></div>
                        <% end %>
                      </div>
                    </div>
                  <% end %>
                <% else %>
                  <div class="team-list-row">ยังไม่มีทีมที่สนใจหรือสมัครในรุ่นนี้</div>
                <% end %>
              </div>
            <% end %>

            <% if regs_without_div.any? %>
              <div
                class="team-tab-panel"
                id="division-unassigned"
                style="display:<%= divisions.empty? ? 'block' : 'none' %>;">
                <% sorted_regs = regs_without_div.sort_by { |reg| [status_order[reg.status] || 1, reg.created_at] } %>
                <% sorted_regs.each do |reg| %>
                  <% display_state = case reg.status
                                     when "confirmed", "paid" then :confirmed
                                     else :applied
                                     end %>

                  <% badge_class = case display_state
                                   when :applied   then "team-status-badge team-status-badge--applied"
                                   when :confirmed then "team-status-badge team-status-badge--confirmed"
                                   end %>

                  <% label = display_state == :applied ? "สมัครแล้ว" : "ยืนยันแล้ว" %>
                  <div class="team-list-row">
                    <div>
                      <div><strong><%= reg.team.name %></strong></div>
                      <div style="font-size:11px;color:#78909c;">โทร: <%= reg.team.contact_phone %></div>
                    </div>
                    <div style="display:flex;align-items:center;gap:6px;">
                      <% if can_manage_registrations?(@tournament) %>
                        <% target_status = (display_state == :confirmed ? "applied" : "confirmed") %>
                        <%= button_to label,
                              tournament_team_registration_path(@tournament, reg),
                              method: :patch,
                              params: { team_registration: { status: target_status } },
                              class: "team-status-badge #{badge_class}",
                              form_class: "inline-form" %>
                        <%= button_to "ลบ",
                              tournament_team_registration_path(@tournament, reg),
                              method: :delete,
                              data: { confirm: "ลบทีมนี้ออกจากรายการแข่ง?" },
                              class: "btn btn-sm btn-outline-danger",
                              form_class: "inline-form" %>
                      <% else %>
                        <div class="<%= badge_class %>"><%= label %></div>
                      <% end %>
                    </div>
                  </div>
                <% end %>
              </div>
            <% end %>
          </div>
        <% else %>
          <div class="team-list-row">ยังไม่มีทีมที่สนใจหรือสมัคร</div>
        <% end %>
      </div>
    </div>
  </div>
</div>
